# Story 2.2: 可编辑文本区域识别

## Status
Completed - 2025-08-22
# Story 2.2: 可编辑文本区域识别

# Story 2.2: 可编辑文本区域识别

## Status
Draft

## Story
**As a** 用户,
**I want** 能够识别哪些文本可以编辑,
**so that** 我知道在哪里可以进行修改操作

## Acceptance Criteria
1. 鼠标悬停时高亮显示可编辑文本区域
2. 区分可编辑文本和不可编辑元素（图片、表格等）
3. 提供视觉反馈指示编辑状态
4. 支持文本块级别的编辑区域识别
5. 处理复杂布局中的文本区域边界
6. 编辑区域识别响应时间小于100ms

## Tasks / Subtasks
- [ ] 实现文本区域分类 (AC: 2, 4)
  - [ ] 分析PDF元素类型（文本、图像、路径等）
  - [ ] 识别可编辑文本块和只读元素
  - [ ] 处理表单字段的特殊情况
  - [ ] 区分标题、正文、注释等文本类型
- [ ] 创建悬停高亮效果 (AC: 1, 3)
  - [ ] 实现鼠标悬停事件监听
  - [ ] 创建高亮覆盖层组件
  - [ ] 设计视觉反馈样式
  - [ ] 添加平滑的动画过渡效果
- [ ] 开发区域边界检测 (AC: 5)
  - [ ] 实现文本块边界计算算法
  - [ ] 处理多列布局的文本区域
  - [ ] 支持不规则形状的文本区域
  - [ ] 优化重叠文本的边界处理
- [ ] 性能优化 (AC: 6)
  - [ ] 实现区域识别结果缓存
  - [ ] 优化鼠标移动事件处理频率
  - [ ] 使用防抖技术减少计算开销
  - [ ] 添加性能监控和指标收集

## Dev Notes

### 文本元素分类系统
基于PDF.js的元素类型识别：
```typescript
enum PDFElementType {
  TEXT = 'text',
  IMAGE = 'image',
  PATH = 'path',
  FORM_FIELD = 'form',
  ANNOTATION = 'annotation'
}

interface EditableTextArea {
  id: string;
  type: PDFElementType;
  isEditable: boolean;
  bbox: BoundingBox;
  textContent: string;
  styleInfo: TextStyle;
  confidence: number;  // 可编辑性置信度
}

class TextAreaClassifier {
  classifyElement(element: PDFElement): EditableTextArea {
    const isEditable = this.determineEditability(element);
    return {
      id: this.generateId(),
      type: element.type,
      isEditable,
      bbox: this.calculateBoundingBox(element),
      textContent: element.text || '',
      styleInfo: this.extractStyle(element),
      confidence: this.calculateConfidence(element)
    };
  }
}
```
[Source: architecture.md#components]

### 悬停高亮组件
```typescript
interface HighlightOverlay {
  show(area: EditableTextArea): void;
  hide(): void;
  updatePosition(area: EditableTextArea): void;
}

class TextAreaHighlight extends React.Component<HighlightProps> {
  render() {
    const { area, isVisible } = this.props;
    
    return (
      <div
        className={`text-highlight ${isVisible ? 'visible' : 'hidden'}`}
        style={{
          position: 'absolute',
          left: area.bbox.left,
          top: area.bbox.top,
          width: area.bbox.width,
          height: area.bbox.height,
          backgroundColor: 'rgba(0, 123, 255, 0.2)',
          border: '1px solid #007bff',
          borderRadius: '2px',
          pointerEvents: 'none',
          transition: 'all 0.2s ease-in-out'
        }}
      />
    );
  }
}
```
[Source: architecture.md#frontend-architecture]

### 鼠标事件处理
```typescript
class MouseInteractionHandler {
  private debounceTimer: NodeJS.Timeout | null = null;
  private currentHighlightedArea: EditableTextArea | null = null;
  
  handleMouseMove = (event: MouseEvent): void => {
    // 防抖处理，避免过频繁的计算
    if (this.debounceTimer) {
      clearTimeout(this.debounceTimer);
    }
    
    this.debounceTimer = setTimeout(() => {
      this.processMousePosition(event.clientX, event.clientY);
    }, 16); // ~60fps
  };
  
  private processMousePosition(x: number, y: number): void {
    const area = this.textLocationService.findEditableAreaAtPoint(x, y);
    
    if (area !== this.currentHighlightedArea) {
      this.updateHighlight(area);
      this.currentHighlightedArea = area;
    }
  }
}
```
[Source: architecture.md#core-workflows]

### 可编辑性判断规则
```typescript
class EditabilityRules {
  determineEditability(element: PDFElement): boolean {
    // 基本规则
    if (element.type === PDFElementType.IMAGE) return false;
    if (element.type === PDFElementType.PATH) return false;
    
    // 文本特定规则
    if (element.type === PDFElementType.TEXT) {
      // 检查是否为标题（通常字体较大，加粗）
      if (this.isLikelyTitle(element)) return true;
      
      // 检查是否为正文
      if (this.isBodyText(element)) return true;
      
      // 检查是否为水印或背景文字
      if (this.isWatermarkText(element)) return false;
    }
    
    // 表单字段通常可编辑
    if (element.type === PDFElementType.FORM_FIELD) return true;
    
    return true; // 默认可编辑
  }
  
  private isLikelyTitle(element: PDFElement): boolean {
    return element.fontSize > 14 && element.fontWeight === 'bold';
  }
  
  private isBodyText(element: PDFElement): boolean {
    return element.fontSize >= 9 && element.fontSize <= 14;
  }
}
```
[Source: architecture.md#components]

### 复杂布局处理
```typescript
class LayoutAnalyzer {
  analyzeTextLayout(textBlocks: TextBlock[]): LayoutInfo {
    return {
      columns: this.detectColumns(textBlocks),
      readingOrder: this.determineReadingOrder(textBlocks),
      textRegions: this.groupTextRegions(textBlocks)
    };
  }
  
  private detectColumns(textBlocks: TextBlock[]): Column[] {
    // 基于X坐标聚类检测列
    const xPositions = textBlocks.map(block => block.x);
    const clusters = this.clusterPositions(xPositions);
    return clusters.map(cluster => ({
      left: Math.min(...cluster),
      right: Math.max(...cluster),
      textBlocks: textBlocks.filter(block => 
        cluster.includes(block.x)
      )
    }));
  }
}
```
[Source: architecture.md#components]

### 视觉反馈设计
- **悬停状态**: 浅蓝色半透明背景 + 蓝色边框
- **可编辑指示**: 鼠标指针变为文本光标
- **编辑中状态**: 更深的蓝色背景 + 虚线边框
- **不可编辑**: 红色边框 + 禁止图标
[Source: prd.md#key-interaction-paradigms]

### 性能监控指标
```typescript
interface PerformanceMetrics {
  averageRecognitionTime: number;  // 平均识别时间
  cacheHitRate: number;           // 缓存命中率
  mouseMoveEventRate: number;     // 鼠标移动事件频率
  memoryUsage: number;            // 内存使用量
}
```
[Source: architecture.md#monitoring-and-observability]

### Testing
**测试文件位置**: `tests/renderer/components/EditableAreaRecognition.test.tsx`
**测试框架**: Jest + React Testing Library + Canvas Mock
**关键测试场景**:
- 不同PDF元素类型的识别准确性
- 鼠标悬停高亮效果
- 复杂布局的区域边界检测
- 性能基准测试（响应时间<100ms）
- 内存泄漏检测
**测试标准**:
- 元素分类准确率≥90%
- 高亮响应时间<100ms
- 无内存泄漏
- 视觉回归测试通过
[Source: architecture.md#testing-strategy]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-21 | v1.0 | 初始故事创建 | Bob (SM) |

## Dev Agent Record
*此部分将在开发实施过程中由开发代理填充*

### Agent Model Used
*待填充*

### Debug Log References
*待填充*

### Completion Notes List
*待填充*

### File List
*待填充*

## QA Results
*此部分将在QA代理审查完成后填充*